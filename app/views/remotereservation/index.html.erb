<%= javascript_include_tag 'tablelock'%>

<div style="margin-left:4em">
<form action="/reservation/express_2" method="post">
  <div id='dates'>
    <%= render :partial => 'dates' %>
  </div>
  <p>
  <%= render :partial => 'sitetype' %>
  </p>
  <p>
  <%= render :partial => 'count' %>
  <span id="spaces">
    <%= render :partial => 'space_pulldown' %>
  </span>
  </p>
  <span style="display: none">
    <%= collection_select(:reservation, :discount_id, Discount.active, :id, :name, {:prompt => true}) if @option.use_discount? && Discount.active.count > 0 %>
  </span>
  <p><%= submit_tag I18n.t('reservation.CompleteReservation') %></p>
</form>
  <a href="../images/sitemap.jpg" onclick="goclicky(this); return false;" target="_blank" class="sitemap">Site Map</a>
  <br><br>
  <table id="available" class="available" cellspacing="0" admin-session="<%= session[:admin_status] %>">
    <thead>
      <%= header -%>
    </thead>
    <tbody>
      <%= available() %>
    </tbody>
  </table>
</div>

<script type="text/javascript">
  TableLock("available", "av_space", "av_date", "locked");

  var current_url = window.location.href;
  const url = new URL(
    current_url
  );
  var glb_start_date = url.searchParams.get('start_date');
  var glb_space = url.searchParams.get('space');
  if(glb_start_date !== null && glb_space !== null) {
    var spaceSelect = document.getElementsByName("space[space_id]")[0];
    for (var i = 0; i < spaceSelect.options.length; ++i) {
        if (spaceSelect.options[i].text === glb_space) {
          spaceSelect.options[i].selected = true;
        }  
    }
    var calendar = glbStartCalendarDateSelect;
    var d = new Date();
    calendar.date = new Date();
    var o = $H({ day: glb_start_date, month: d.getMonth(), year: d.getFullYear(), hour: d.getHours(), minute: d.getMinutes() });
    calendar.updateSelectedDate(o, true);
    calendar.refresh();
  }

  var cells = document.querySelectorAll(".available td");
  var table = document.getElementsByTagName('table')[0];
  for (var i = 0; i < cells.length; i++) {
    if (cells[i].hasChildNodes()) {
      if(cells[i].childNodes[0].tagName == "A") {
        cells[i].parentElement.setAttribute("hasspace", "true");
      }
    }else{
      cells[i].setAttribute('style', 'cursor: pointer');
      cells[i].addEventListener("click", function(){
        handler(this);
     });
    } 
  }
  function handler(param) {
    var spaceSelect = document.getElementsByName("space[space_id]")[0];
    var parentTr = param.parentElement;
    if(parentTr.getAttribute("hasspace") != "true") {
      var obj = parentTr.getElementsByTagName("td")[0];
      var cellindex = param.cellIndex;

      var start_date = parentTr.parentElement.parentElement.children[0].children[1].children[cellindex].textContent;
      var spaceTxt = obj.textContent;

      for (var i = 0; i < spaceSelect.options.length; ++i) {
          if (spaceSelect.options[i].text === spaceTxt) {
            spaceSelect.options[i].selected = true;
          }  
      }
      var calendar = glbStartCalendarDateSelect;
      var d = new Date();
      calendar.date = new Date();
      var o = $H({ day: start_date, month: d.getMonth(), year: d.getFullYear(), hour: d.getHours(), minute: d.getMinutes() });
      calendar.updateSelectedDate(o, true);
      calendar.refresh();
    }else{
      alert("This space is already reserved. Try a different space.");
      return;
    }
  }
  function FindLeftWindowBoundry()
  {
    // In Internet Explorer window.screenLeft is the window's left boundry
    if (window.screenLeft)
    {
      return window.screenLeft;
    }
    
    // In Firefox window.screenX is the window's left boundry
    if (window.screenX)
      return window.screenX;
      
    return 0;
  }
  // Find Left Boundry of current Window
  function FindTopWindowBoundry()
  {
    // In Internet Explorer window.screenLeft is the window's left boundry
    if (window.screenTop)
    {
      return window.screenTop;
    }
    
    // In Firefox window.screenY is the window's left boundry
    if (window.screenY)
      return window.screenY;
      
    return 0;
  }
      
  function goclicky(meh)
  {
      var x = screen.width/2 - 700/2 + FindLeftWindowBoundry();
      var y = screen.height/2 - 450/2 + FindTopWindowBoundry();
      window.open(meh.href, 'sharegplus','height=600,width=700,left='+x+',top='+y);
  }
</script>
